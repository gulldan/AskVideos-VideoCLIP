import datetime
import glob
import os
import subprocess
from argparse import Namespace

import torch
import yappi
from torch.nn import functional as F
from video_llama.common.config import Config
from video_llama.common.registry import registry
from video_llama.processors import Blip2ImageEvalProcessor
from video_llama.processors.video_processor import (
    load_video,
)

DEVICE = "cuda"


def init(args):
    cfg = Config(args)
    model_config = cfg.model_cfg
    model_config.device_8bit = args.gpu_id
    model_cls = registry.get_model_class(model_config.arch)
    model = model_cls.from_config(model_config).to(f"cuda:{args.gpu_id}")
    model.eval()
    vis_processor_cfg = cfg.datasets_cfg.webvid.vis_processor.train
    vis_processor = registry.get_processor_class(vis_processor_cfg.name).from_config(vis_processor_cfg)
    img_processor = Blip2ImageEvalProcessor()
    return model, vis_processor, img_processor


def load_model(eval_config):
    gpu_id = 0
    args = {"cfg_path": eval_config, "gpu_id": gpu_id, "options": None}
    args = Namespace(**args)

    cfg = Config(args)
    model_config = cfg.model_cfg
    model_config.device_8bit = args.gpu_id
    model_cls = registry.get_model_class(model_config.arch)
    model = model_cls.from_config(model_config).to(f"cuda:{args.gpu_id}")
    model.eval()

    vis_processor_cfg = cfg.datasets_cfg.webvid.vis_processor.train
    vis_processor = registry.get_processor_class(vis_processor_cfg.name).from_config(vis_processor_cfg)

    return model, vis_processor


def upload_video(model, video_path, vis_processor):
    video = load_video(
        video_path=video_path,
        n_frms=16,
        # n_frms=8,
        height=224,
        width=224,
        sampling="uniform",
        return_msg=False,
    )
    video = vis_processor.transform(video).unsqueeze(0).to(DEVICE)

    return model.encode_videoQformer_visual(video)[-1].last_hidden_state


def get_all_video_embeddings(video_paths, model, vis_processor):
    video_embs = []
    for video_path in video_paths:
        embs = upload_video(model, video_path, vis_processor)
        embs = F.normalize(model.vision_proj(embs), dim=-1)
        video_embs.append(F.normalize(torch.mean(embs, dim=1), dim=-1))
    return video_embs


def embed_text_itc(model, prompt):
    inputs = model.tokenizer(prompt, padding="max_length", truncation=True, max_length=320, return_tensors="pt").to("cuda")
    embds = model.video_Qformer.bert(inputs.input_ids, inputs.attention_mask, return_dict=True).last_hidden_state
    embds = F.normalize(model.text_proj(embds[:, 0, :]), dim=-1)
    # print("text", embds.tolist())
    return embds


def compute_itc(model, prompts, video_emb):
    text_embs = []
    for prompt in prompts:
        text_embs.append(embed_text_itc(model, prompt))
    text_embs = torch.cat(text_embs)
    # print(text_embs.shape)
    # sim_q2t = torch.einsum("iqf,tf->itq", video_emb, text_embs)
    sim_q2t = torch.einsum("if,tf->it", video_emb, text_embs)

    sim, _ = sim_q2t.max(dim=-1)
    # sim = torch.mm(video_emb, text_embs.t())
    v_emb_test = {
        "embedding": [
            -0.010989885777235031,
            -0.006382942199707031,
            -0.011456284672021866,
            -0.015092029236257076,
            -0.009701197035610676,
            0.04910092428326607,
            -0.05382616072893143,
            -0.006643787492066622,
            0.02688479796051979,
            -0.01787693053483963,
            -0.02993205562233925,
            0.004739017225801945,
            -0.02046622894704342,
            -0.014026565477252007,
            -0.012402514927089214,
            0.028528627008199692,
            -0.027183575555682182,
            0.02346741035580635,
            -0.002767319791018963,
            -0.014112741686403751,
            0.040215250104665756,
            0.002023556735366583,
            -0.020703773945569992,
            0.04988732561469078,
            0.10138729959726334,
            -0.004493881482630968,
            -0.004359342623502016,
            0.04313720390200615,
            0.0008473385823890567,
            0.011437534354627132,
            -0.020153068006038666,
            -0.005027003586292267,
            0.0031272268388420343,
            -0.0001965213450603187,
            -0.008905512280762196,
            0.005252073518931866,
            0.02873978577554226,
            -0.00036723294761031866,
            0.02823428064584732,
            -0.022513478994369507,
            -0.005337594076991081,
            -0.024070054292678833,
            0.036564551293849945,
            0.054653946310281754,
            -0.014050258323550224,
            0.0324321985244751,
            -0.02725720964372158,
            0.04664567485451698,
            -0.013068027794361115,
            -0.02192486822605133,
            -0.0014643727336078882,
            -0.013418980874121189,
            0.0034274887293577194,
            -0.03965642675757408,
            0.0692286267876625,
            -0.037398841232061386,
            0.018558381125330925,
            -0.05966714769601822,
            -0.01494460366666317,
            0.0034494209103286266,
            -0.05036155879497528,
            0.0011977421818301082,
            -0.03329795226454735,
            -0.0035957549698650837,
            -0.0008611020166426897,
            0.01857566647231579,
            -0.028960349038243294,
            -0.04354807734489441,
            -0.07277824729681015,
            0.023551607504487038,
            -0.016140807420015335,
            -0.0009674496250227094,
            0.005606971215456724,
            0.0034327376633882523,
            -0.005130943842232227,
            -0.012893113307654858,
            -0.014960236847400665,
            0.012922964990139008,
            0.002114234259352088,
            0.0060459463857114315,
            0.010525156743824482,
            0.033800166100263596,
            0.0025555870961397886,
            0.029347766190767288,
            -0.01741144433617592,
            -0.011940655298531055,
            0.004696687217801809,
            -0.011928520165383816,
            0.041163790971040726,
            0.0030519217252731323,
            0.01836802065372467,
            -0.05949794128537178,
            -0.013860837556421757,
            -0.016320345923304558,
            -0.05316784605383873,
            0.07660573720932007,
            -0.0429181270301342,
            0.01632278971374035,
            0.014408464543521404,
            -0.05405610799789429,
            0.00660964148119092,
            0.02137034200131893,
            -0.026174264028668404,
            -0.0011331577552482486,
            0.021792428568005562,
            0.022235145792365074,
            0.010460009798407555,
            0.007818842306733131,
            -0.02687089890241623,
            0.009662351571023464,
            -0.012471344321966171,
            0.0351104661822319,
            0.02234649285674095,
            0.00545101473107934,
            0.006389886140823364,
            0.011079974472522736,
            -0.03816990926861763,
            0.026947129517793655,
            -0.02971300669014454,
            0.02505289576947689,
            0.023744061589241028,
            -0.04040995612740517,
            0.000021740268493886106,
            0.0012573114363476634,
            0.018167516216635704,
            0.015738727524876595,
            -0.03479878604412079,
            -0.02489764429628849,
            -0.0022155954502522945,
            0.018602672964334488,
            -0.005538193043321371,
            0.08119554072618484,
            0.033458027988672256,
            -0.015353989787399769,
            0.005593523848801851,
            -0.0034716606605798006,
            -0.007892743684351444,
            0.021631605923175812,
            -0.01594458892941475,
            0.04617193713784218,
            0.02009848691523075,
            -0.008857645094394684,
            -0.020657746121287346,
            0.008019226603209972,
            -0.017621604725718498,
            0.039691485464572906,
            -0.044810276478528976,
            -0.02817908674478531,
            -0.00997347291558981,
            -0.044233180582523346,
            -0.02718239277601242,
            0.020870845764875412,
            0.006622111424803734,
            0.013246624730527401,
            0.011750048957765102,
            0.011706058867275715,
            0.00461197504773736,
            -0.03136475756764412,
            0.01686607301235199,
            0.03776877373456955,
            -0.028943374752998352,
            0.009928135201334953,
            -0.047756947576999664,
            0.003765453351661563,
            0.00981279369443655,
            0.021491849794983864,
            -0.01949150115251541,
            0.011426988989114761,
            0.027889037504792213,
            -0.0009703476680442691,
            -0.02369672991335392,
            0.024114226922392845,
            -0.025068726390600204,
            -0.033922597765922546,
            0.0062522864900529385,
            -0.014842365868389606,
            0.009284249506890774,
            0.024519287049770355,
            0.0024882876314222813,
            -0.01806214265525341,
            -0.022322947159409523,
            0.012651551514863968,
            -0.013641162775456905,
            -0.0008402967359870672,
            -0.032875847071409225,
            -0.010945936664938927,
            0.002418444724753499,
            -0.001364809344522655,
            -0.03327958658337593,
            -0.020995240658521652,
            0.04781331494450569,
            0.022456491366028786,
            0.050870735198259354,
            -0.0021155409049242735,
            -0.07410918921232224,
            0.023856407031416893,
            0.05368136242032051,
            0.03803878277540207,
            0.019178884103894234,
            -0.02299029938876629,
            0.02680291421711445,
            0.0020997643005102873,
            0.0005827383138239384,
            0.0064062695018947124,
            -0.049242544919252396,
            0.0066330102272331715,
            -0.013284786604344845,
            0.10243091732263565,
            -0.1573447287082672,
            0.03719751909375191,
            -0.037869155406951904,
            0.009288030676543713,
            0.008978289552032948,
            0.039959684014320374,
            -0.01598074473440647,
            0.02188834920525551,
            0.011577536351978779,
            -0.05075088143348694,
            0.0014712943229824305,
            -0.05710203945636749,
            -0.03237167373299599,
            0.051626257598400116,
            0.009865319356322289,
            -0.034063972532749176,
            0.011636298149824142,
            0.01569414883852005,
            -0.03258838504552841,
            -0.10954947024583817,
            -0.006184736732393503,
            -0.013227155432105064,
            -0.012286901473999023,
            0.010715549811720848,
            0.020584337413311005,
            0.015866145491600037,
            0.061067841947078705,
            0.026405267417430878,
            0.005316202528774738,
            -0.027664372697472572,
            0.0438946932554245,
            -0.025038059800863266,
            -0.016359640285372734,
            0.025048183277249336,
            -0.061586637049913406,
            -0.0415327288210392,
            0.01950176991522312,
            0.032160043716430664,
            0.004991127643734217,
            0.03260432928800583,
            0.055567268282175064,
            0.0007394432323053479,
            -0.031194858253002167,
            -0.04059099033474922,
            0.018547071143984795,
            0.005824073683470488,
            -0.04652729630470276,
            0.03539004921913147,
            -0.014659548178315163,
            0.026799675077199936,
            -0.002122096251696348,
            -0.007936826907098293,
            0.01692717708647251,
            -0.018055982887744904,
            0.0031125047244131565,
            0.0214986652135849,
            0.03636450320482254,
            0.047563936561346054,
            0.00432249391451478,
            0.05216023325920105,
            -0.03604213520884514,
            0.0150215532630682,
            0.0031798926647752523,
            0.016568414866924286,
            -0.0045237778685987,
            -0.05022114887833595,
            0.05215451866388321,
            0.007190241944044828,
            -0.02588384784758091,
            0.03204828500747681,
            -0.03761065751314163,
            0.01944994553923607,
            -0.014958728104829788,
            -0.031022246927022934,
            0.015343956649303436,
            -0.04101354256272316,
            -0.03486150875687599,
            0.025666460394859314,
            -0.009895370341837406,
            0.026426542550325394,
            -0.028296152129769325,
            -0.00008071213960647583,
            -0.00877116248011589,
            -0.02664846181869507,
            -0.0018064642790704966,
            -0.015283174812793732,
            -0.07576137036085129,
            -0.039916109293699265,
            -0.012647971510887146,
            0.026614109054207802,
            -0.028779027983546257,
            -0.021233581006526947,
            -0.004985824227333069,
            -0.14072558283805847,
            -0.02204095758497715,
            -0.01309855654835701,
            0.024017611518502235,
            -0.03491748869419098,
            0.04037961736321449,
            0.002402885816991329,
            0.06299722194671631,
            -0.009262990206480026,
            0.06430359184741974,
            -0.02749793604016304,
            -0.04119305685162544,
            -0.00546638946980238,
            -0.03286737576127052,
            0.004185112193226814,
            -0.015298241749405861,
            -0.009849688038229942,
            0.03182760253548622,
            0.026213085278868675,
            0.025431456044316292,
            0.026804545894265175,
            0.004257949069142342,
            0.006082839332520962,
            0.047964900732040405,
            0.017325865104794502,
            -0.0008606920600868762,
            -0.016982940956950188,
            -0.027281327173113823,
            0.002941108075901866,
            -0.02465445175766945,
            -0.0015961081953719258,
            -0.0003207333793397993,
            -0.01930789090692997,
            -0.023657111451029778,
            -0.010031521320343018,
            -0.018519597128033638,
            0.006617086473852396,
            -0.052905499935150146,
            0.006949126720428467,
            0.013812178745865822,
            -0.012852050364017487,
            0.006039001047611237,
            0.008812790736556053,
            0.04030539467930794,
            0.016242336481809616,
            -0.00033190465182997286,
            -0.0035616427194327116,
            0.013515512458980083,
            -0.004638041369616985,
            0.00043441751040518284,
            0.011998508125543594,
            0.00867498479783535,
            -0.004277671221643686,
            -0.018327070400118828,
            -0.003212988143786788,
            -0.003855830291286111,
            -0.04849474877119064,
            -0.00825758371502161,
            -0.017018530517816544,
            -0.019758636131882668,
            -0.0035897549241781235,
            0.0033490825444459915,
            -0.021831154823303223,
            -0.003167248098179698,
            0.03650316223502159,
            -0.009603030048310757,
            -0.010913646779954433,
            -0.05615726485848427,
            -0.013087119907140732,
            -0.007211470045149326,
            -0.00025037239538505673,
            -0.056092485785484314,
            -0.0031337521504610777,
            0.021824248135089874,
            0.03086625412106514,
            0.02148205041885376,
            -0.002786520402878523,
            -0.014262750744819641,
            0.02199430949985981,
            0.007062268443405628,
            0.0280913095921278,
            -0.030267519876360893,
            0.03219910338521004,
            -0.03813624009490013,
            0.014526842162013054,
            0.021813182160258293,
            0.017791105434298515,
            -0.015455029904842377,
            -0.04506032168865204,
            -0.050931431353092194,
            -0.04513636976480484,
            0.023699291050434113,
            -0.02219448797404766,
            0.009466482326388359,
            0.0255272313952446,
            -0.022086672484874725,
            0.0020038359798491,
            0.003437321400269866,
            0.022003673017024994,
            0.018445497378706932,
            0.04484749585390091,
            0.0036912746727466583,
            -0.007365772966295481,
            0.03995618596673012,
            -0.004630290903151035,
            0.03361045569181442,
            0.013819039799273014,
            0.021375928074121475,
            0.05103924870491028,
            -0.03431687504053116,
            0.057943765074014664,
            0.005491317715495825,
            0.01959599368274212,
            0.02311151847243309,
            -0.040510136634111404,
            -0.005235989112406969,
            0.0015507052885368466,
            0.06717193871736526,
            0.0027769505977630615,
            0.010383499786257744,
            -0.004164841957390308,
            0.025548920035362244,
            -0.02597583271563053,
            0.018374226987361908,
            -0.02390589937567711,
            0.03385138139128685,
            0.05200181156396866,
            -0.0009287335560657084,
            0.024581190198659897,
            -0.05885406956076622,
            -0.001147874747402966,
            0.06195147708058357,
            -0.01421102974563837,
            0.019508304074406624,
            0.010862867347896099,
            0.004381912760436535,
            0.015699805691838264,
            -0.08273082226514816,
            -0.03152408078312874,
            0.02883160300552845,
            -0.011570675298571587,
            0.010623137466609478,
            0.035816919058561325,
            -0.05307541787624359,
            -0.012286963872611523,
            0.018292559310793877,
            0.033452730625867844,
            -0.0013347977073863149,
            0.031120721250772476,
            -0.005635732319205999,
            -0.010818087495863438,
            0.021650657057762146,
            -0.0057058678939938545,
            -0.012225198559463024,
            -0.0019494567532092333,
            -0.04686149209737778,
            0.0010699941776692867,
            0.010449806228280067,
            -0.04821295291185379,
            -0.00007623312558280304,
            -0.03844510018825531,
            0.02313367649912834,
            0.02469738759100437,
            -0.014464032836258411,
            0.01631900668144226,
            -0.04635869339108467,
            0.013857115060091019,
            0.009527390822768211,
            0.0019076525932177901,
            0.01868918351829052,
            0.01521732285618782,
            0.02935434877872467,
            -0.02361541986465454,
            -0.054034117609262466,
            0.02946976199746132,
            -0.04096938669681549,
            -0.021284697577357292,
            -0.02198801375925541,
            0.0026133358478546143,
            0.06680082529783249,
            -0.04858282580971718,
            0.017086366191506386,
            -0.016039595007896423,
            -0.03129635751247406,
            -0.02780201844871044,
            -0.027844564989209175,
            -0.002789089921861887,
            0.015848172828555107,
            0.043952349573373795,
            -0.019204022362828255,
            0.0031444989144802094,
            -0.008803064003586769,
            -0.006380701903253794,
            0.04017569497227669,
            0.014366529881954193,
            0.05724092945456505,
            -0.011580613441765308,
            -0.0064550526440143585,
            0.02862921915948391,
            0.009247954934835434,
            -0.026125222444534302,
            -0.0026198779232800007,
            -0.03716771677136421,
            0.010394742712378502,
            -0.004587186500430107,
            -0.023848596960306168,
            0.02698994241654873,
            0.003737412393093109,
            -0.05194803699851036,
            0.011726117692887783,
            0.010688181035220623,
            -0.05887971445918083,
            -0.009300125762820244,
            -0.025895431637763977,
            -0.027078215032815933,
            -0.02011357620358467,
            -0.0268279779702425,
            -0.02421635389328003,
            0.0058028860948979855,
            -0.0010042429203167558,
            0.037303466349840164,
            -0.02906879596412182,
            0.026088224723935127,
            -0.018443400040268898,
            0.016699647530913353,
            0.04796210676431656,
            -0.046827282756567,
            0.003323277924209833,
            -0.043329596519470215,
            0.03650030121207237,
            0.139093816280365,
            -0.0022154180333018303,
            0.0006416263640858233,
            0.08212435245513916,
            -0.02264048345386982,
            -0.01253592036664486,
            0.020091762766242027,
            0.01777350716292858,
            0.015971707180142403,
            0.0076615153811872005,
            -0.033396072685718536,
            0.019022762775421143,
            0.0010882723145186901,
            0.017511824145913124,
            0.06540511548519135,
            -0.003263759193941951,
            -0.02841044031083584,
            0.01114686019718647,
            0.009697308763861656,
            -0.04794548451900482,
            -0.05569146201014519,
            -0.0165252722799778,
            0.011766721494495869,
            -0.017941223457455635,
            0.0001978633226826787,
            0.044249702244997025,
            -0.005336752627044916,
            0.01575690694153309,
            -0.055946700274944305,
            0.01020759530365467,
            -0.06003639101982117,
            -0.03980894386768341,
            0.044812362641096115,
            -0.006276024971157312,
            0.02321559749543667,
            0.009051691740751266,
            -0.1235559731721878,
            -0.0024420025292783976,
            0.0036614660639315844,
            0.007669633720070124,
            0.030507588759064674,
            -0.05332601070404053,
            -0.0277410876005888,
            -0.02517547272145748,
            -0.020797934383153915,
            0.04185329005122185,
            -0.0035280799493193626,
            -0.09872587770223618,
            0.00004244953015586361,
            -0.01531899906694889,
            -0.004786819685250521,
            0.04709591343998909,
            -0.023648975417017937,
            -0.015316876582801342,
            0.020062196999788284,
            0.002372456481680274,
            -0.021702399477362633,
            0.046424489468336105,
            -0.020127365365624428,
            0.016703633591532707,
            -0.007042686454951763,
            0.008811396546661854,
            0.013063047081232071,
            -0.011420338414609432,
            0.0006522994954138994,
            0.032670095562934875,
            -0.00969054363667965,
            0.02266858145594597,
            0.03950296342372894,
            0.033331248909235,
            -0.03277082368731499,
            0.013097332790493965,
            -0.004298210609704256,
            -0.008414649404585361,
            -0.03439498320221901,
            0.009059404954314232,
            -0.010548247955739498,
            0.0003911078965757042,
            0.017361776903271675,
            0.036556389182806015,
            0.07391186058521271,
            0.03722597286105156,
            0.015866685658693314,
            0.011095736175775528,
            0.011758039705455303,
            0.020244762301445007,
            0.031669918447732925,
            -0.020544221624732018,
            -0.00416569272056222,
            -0.021900739520788193,
            -0.01264252234250307,
            -0.013534457422792912,
            0.007607581559568644,
            -0.031110022217035294,
            -0.009534891694784164,
            -0.002543546725064516,
            0.007165608927607536,
            -0.010497000999748707,
            0.008203654550015926,
            0.020732538774609566,
            0.040613386780023575,
            -0.03287667781114578,
            0.022172536700963974,
            0.030007243156433105,
            0.017307551577687263,
            -0.0025427343789488077,
            0.013291958719491959,
            -0.07811815291643143,
            0.01128927432000637,
            -0.005018796771764755,
            0.03083965554833412,
            0.08095884323120117,
            -0.024154312908649445,
            0.00873791053891182,
            0.008679416961967945,
            0.016422834247350693,
            -0.02134772762656212,
            -0.025462625548243523,
            0.009114318527281284,
            0.07729092985391617,
            0.04658319056034088,
            0.019458463415503502,
            0.000770776707213372,
            -0.015651365742087364,
            0.029482973739504814,
            0.050609879195690155,
            -0.0009569537942297757,
            0.035469744354486465,
            0.01843920350074768,
            -0.030498305335640907,
            -0.03847440704703331,
            -0.03456834703683853,
            -0.006265698932111263,
            0.020261095836758614,
            -0.015721987932920456,
            0.02537226863205433,
            0.010734392330050468,
            -0.0011576783144846559,
            0.010796226561069489,
            0.026736926287412643,
            -0.01644214056432247,
            0.02601163648068905,
            0.02662453055381775,
            0.0071573397144675255,
            0.01846405491232872,
            -0.03450506180524826,
            0.04667632654309273,
            -0.04084298014640808,
            0.04910735413432121,
            -0.02930300496518612,
            -0.009995725937187672,
            -0.03676660358905792,
            0.02168976701796055,
            -0.00025956815807148814,
            -0.007686498109251261,
            -0.01769120618700981,
            0.014832926914095879,
            -0.027949295938014984,
            -0.014051740057766438,
            -0.05923229828476906,
            0.0017860716907307506,
            0.007484969217330217,
            0.06538768112659454,
            -0.019159194082021713,
            -0.035712964832782745,
            0.00830298662185669,
            -0.02558203414082527,
            -0.006888930685818195,
            -0.03626672178506851,
            0.008645460940897465,
            0.07879472523927689,
            -0.005826048087328672,
            0.020014727488160133,
            -0.01431615836918354,
            0.011070754379034042,
            0.025264473631978035,
            0.004572166595607996,
            0.07049519568681717,
            -0.030164282768964767,
            -0.05449351668357849,
            -0.019166892394423485,
            0.016214074566960335,
            0.05023228004574776,
            0.005756588187068701,
            -0.00031306216260418296,
            -0.06455417722463608,
            0.017063621431589127,
            -0.023128995671868324,
            0.013739585876464844,
            -0.007739875931292772,
            0.0415465421974659,
            0.0076763383112847805,
            0.021438749507069588,
            -0.00671894708648324,
            0.02665426768362522,
            -0.03212931007146835,
            -0.032406147569417953,
            -0.01771516352891922,
            -0.01498720794916153,
            -0.03560207784175873,
            -0.026082243770360947,
            0.0023759405594319105,
            -0.0011413645697757602,
            0.025883687660098076,
            -0.0706770047545433,
            -0.041263967752456665,
            -0.008380304090678692,
            0.03529605641961098,
            -0.01256872620433569,
            0.01940799318253994,
            0.037941623479127884,
            -0.04277714341878891,
            0.02257850207388401,
            -0.012265047989785671,
            -0.029809968546032906,
            0.006350265350192785,
            -0.012389510869979858,
            -0.03216642513871193,
            0.0291327852755785,
            0.01332216989248991,
            -0.02062639594078064,
            0.009244025684893131,
            0.027647679671645164,
            0.011353060603141785,
            0.03145241737365723,
            0.008659102022647858,
            -0.024674277752637863,
            -0.0007505452958866954,
            0.021612100303173065,
            0.007567197550088167,
            0.01190982386469841,
            -0.034132443368434906,
            -0.075660839676857,
            0.035062097012996674,
            -0.025505656376481056,
            -0.06535888463258743,
            -0.028861189261078835,
            0.06031450629234314,
            -0.11679971218109131,
            0.01578187756240368,
            -0.02300228923559189,
            0.008767827413976192,
            -0.037967607378959656,
            0.004283516202121973,
            0.010282465256750584,
            0.016123274341225624,
            0.046062763780355453,
            0.004723455756902695,
            0.021709859371185303,
            0.0341358482837677,
            -0.02085176482796669,
            -0.04382160305976868,
            0.03410107642412186,
            0.009738895110785961,
            0.032606761902570724,
            -0.07968630641698837,
            0.01932883821427822,
            0.050256405025720596,
            -0.020808253437280655,
            -0.004724882077425718,
            0.012656857259571552,
            -0.09703134000301361,
            -0.0033368642907589674,
            -0.02644798345863819,
            -0.005273406393826008,
            -0.05881635099649429,
            0.04981424659490585,
            -0.017926394939422607,
            -0.01800183206796646,
            -0.022594725713133812,
            -0.0007961559458635747,
            0.017029568552970886,
            0.02438647300004959,
            0.023845544084906578,
            0.00647116731852293,
            -0.04969944804906845,
            0.032361067831516266,
            -0.020347729325294495,
            0.03626006841659546,
            -0.051530517637729645,
            -0.021927403286099434,
            -0.015147238038480282,
            0.07584718614816666,
            0.01024502795189619,
            0.00514044426381588,
            0.03431202843785286,
            -0.026687774807214737,
            0.007221704348921776,
            0.053551290184259415,
            -0.005409330129623413,
            0.07509659975767136,
            -0.0000839719214127399,
            -0.020535098388791084,
            -0.027514087036252022,
            0.003159555373713374,
            -0.0161319337785244,
            -0.014397834427654743,
            0.017090093344449997,
            0.013351263478398323,
            -0.023316677659749985,
            0.027914997190237045,
            0.036893442273139954,
            0.01843276061117649,
            0.010778388008475304,
            0.005023551173508167,
            -0.034213587641716,
            -0.0011117297690361738,
            0.03792687878012657,
            0.06496983766555786,
            0.05089213699102402,
            -0.0060130879282951355,
            -0.02080502174794674,
            0.0025215852074325085,
            -0.0015228341799229383,
            0.01083320565521717,
            -0.04770885780453682,
            0.0287725068628788,
            -0.02029849775135517,
            0.03384333848953247,
            0.012836405076086521,
            -0.06059199944138527,
            0.03351256623864174,
            0.057328853756189346,
            0.004678142257034779,
            0.04055577144026756,
            0.04137957841157913,
            0.003803401719778776,
            0.02585071511566639,
            -0.008577938191592693,
            0.0021648858673870564,
            -0.05083974823355675,
            0.0020666695199906826,
            -0.010906540788710117,
            -0.03247043117880821,
            -0.022020015865564346,
            -0.08579622209072113,
            -0.004856166895478964,
            0.020555075258016586,
            0.00014413784083444625,
            -0.01296946033835411,
            0.008031817153096199,
            0.0014355590101331472,
            0.012900522910058498,
            -0.0013561670202761889,
            0.03733155503869057,
            0.006847387179732323,
            0.022725852206349373,
            0.03689020127058029,
            0.06949572265148163,
            -0.020959151908755302,
            -0.0006628636037930846,
            -0.03976244479417801,
            -0.036055319011211395,
            0.04104527831077576,
            0.03500627353787422,
            0.009879863820970058,
            0.03703084960579872,
            0.018832270056009293,
            0.0016104178503155708,
            -0.04024398699402809,
            0.027373719960451126,
            0.08912178874015808,
            -0.0007725558243691921,
            0.044146668165922165,
            -0.015385681763291359,
            -0.013259030878543854,
            -0.07714357227087021,
            -0.00938086211681366,
            0.013500966131687164,
            -0.007370637729763985,
            0.01249855849891901,
            0.007860765792429447,
            -0.013018419966101646,
            0.07409008592367172,
            -0.03617735952138901,
            -0.005111789796501398,
            -0.06471233069896698,
            0.017494577914476395,
            0.0067754993215203285,
            0.021241391077637672,
            -0.07197007536888123,
            -0.0020866983104497194,
            -0.012411956675350666,
            -0.01625935733318329,
            -0.04373010993003845,
            -0.03211311623454094,
            0.012179630808532238,
            -0.022010227665305138,
            -0.0016333448002114892,
            0.016189048066735268,
            0.045374590903520584,
            0.029438963159918785,
            -0.06371919810771942,
            -0.011019552126526833,
            -0.015993958339095116,
            -0.004402968566864729,
            -0.003788200905546546,
            0.025051221251487732,
            0.030425596982240677,
            0.0029902190435677767,
            0.03280416876077652,
            -0.0553700216114521,
            0.020926186814904213,
            0.003947199322283268,
            0.029157208278775215,
            0.013454016298055649,
            -0.05377456173300743,
            -0.018238713964819908,
            -0.010129374451935291,
            0.024585304781794548,
            0.007703963201493025,
            -0.047428570687770844,
            -0.010886766016483307,
            0.02912912517786026,
            -0.006667370442301035,
            0.07425279915332794,
            0.008712640032172203,
            -0.050508830696344376,
            -0.026400355622172356,
            -0.005168132949620485,
            -0.009747630916535854,
            0.05462878569960594,
            -0.002541586523875594,
            0.010246030986309052,
            -0.008648603223264217,
            -0.056710273027420044,
            0.005275871604681015,
            -0.0010755349649116397,
            -0.02051370032131672,
            -0.0463937446475029,
            -0.032854627817869186,
            0.020279929041862488,
            0.009186201728880405,
            0.024125894531607628,
            -0.023913338780403137,
            0.014024998061358929,
            -0.057629529386758804,
            -0.020475273951888084,
            0.031946856528520584,
            -0.021081406623125076,
            -0.03026404045522213,
            -0.01226508617401123,
            -0.026478396728634834,
            0.024426817893981934,
            -0.021819686517119408,
            0.0007482400978915393,
            0.016506321728229523,
            0.012217077426612377,
            -0.021875057369470596,
            0.020470643416047096,
            -0.03590703383088112,
            0.010909993201494217,
            0.004095963668078184,
            -0.018457608297467232,
            0.00611678883433342,
            -0.0016175581840798259,
            -0.03497554361820221,
            0.021462392061948776,
            -0.009353809989988804,
            -0.02638603188097477,
            0.009585321880877018,
            0.0413665734231472,
            -0.07512982934713364,
            0.00557987205684185,
            0.01997092179954052,
            0.009099758230149746,
            0.00715544493868947,
            0.011521721258759499,
            -0.024694105610251427,
            -0.0629672110080719,
            0.007822955027222633,
            0.02484286017715931,
            -0.0005109395715408027,
            -0.03924652561545372,
            0.020643284544348717,
            -0.006369634065777063,
            -0.02266106754541397,
            0.020600682124495506,
            -0.028400234878063202,
            0.018078980967402458,
            -0.01618344336748123,
            0.052146948873996735,
            0.010498786345124245,
            0.04286270588636398,
            0.00010700895654736087,
            -0.00275948247872293,
            0.043532226234674454,
            -0.019333483651280403,
            -0.0026500483509153128,
            -0.007233027368783951,
            -0.06530358642339706,
            -0.06119881942868233,
            -0.011533739045262337,
        ]
    }
    a_emb_test = {
        "embedding": [
            0.008945437148213387,
            -0.024332471191883087,
            0.013162103481590748,
            -0.00008778176561463624,
            -0.006422494072467089,
            0.017541775479912758,
            0.020360762253403664,
            -0.00849462766200304,
            0.00872721616178751,
            0.011820738203823566,
            -0.009288476780056953,
            -0.015316897071897984,
            0.0013463665964081883,
            -0.03804667666554451,
            -0.01856997236609459,
            -0.0008189481450244784,
            -0.054198216646909714,
            0.04021504893898964,
            0.020553788170218468,
            -0.014477601274847984,
            0.045612774789333344,
            -0.010685363784432411,
            -0.07251347601413727,
            0.01629265770316124,
            0.009992335923016071,
            -0.05631742626428604,
            -0.0025295212399214506,
            0.07191102206707001,
            -0.04193900153040886,
            -0.009173368103802204,
            -0.014044718816876411,
            0.0629219263792038,
            0.036176130175590515,
            -0.0033454967197030783,
            0.043310411274433136,
            0.046642474830150604,
            0.0157993882894516,
            -0.04546157270669937,
            0.012086299248039722,
            0.04182833060622215,
            0.006990016438066959,
            -0.012022142298519611,
            0.052734002470970154,
            0.0003902744792867452,
            0.0016681255074217916,
            0.04590306803584099,
            0.020419586449861526,
            0.021269861608743668,
            -0.037115804851055145,
            0.029711009934544563,
            -0.022523123770952225,
            -0.01977500133216381,
            -0.02439788728952408,
            -0.05094214901328087,
            -0.019078603014349937,
            -0.00781394261866808,
            -0.03519076481461525,
            0.012121823616325855,
            -0.06587982177734375,
            -0.01340377889573574,
            0.008376487530767918,
            -0.025696128606796265,
            -0.06194039061665535,
            0.00010634373757056892,
            0.07011424005031586,
            0.011566986329853535,
            -0.009796049445867538,
            0.04367668926715851,
            -0.054173242300748825,
            0.004281665198504925,
            0.04626253619790077,
            0.02420596405863762,
            -0.026235846802592278,
            0.03089313954114914,
            0.015583472326397896,
            -0.002934915479272604,
            0.06644199788570404,
            -0.0018224233062937856,
            -0.026320891454815865,
            -0.04862702265381813,
            -0.04412929341197014,
            0.0033265408128499985,
            0.05588535591959953,
            0.01797991432249546,
            0.01575540378689766,
            0.04175010696053505,
            -0.025332201272249222,
            -0.02986222505569458,
            -0.017212122678756714,
            -0.015334904193878174,
            -0.021419748663902283,
            0.011012640781700611,
            0.04415903612971306,
            -0.02292991429567337,
            0.005978819448500872,
            0.0342116579413414,
            -0.003843583632260561,
            -0.013555468991398811,
            0.0327366478741169,
            0.049942608922719955,
            0.01589912362396717,
            0.005477974656969309,
            -0.022364430129528046,
            -0.02520940639078617,
            0.002177017740905285,
            -0.027252987027168274,
            -0.026247911155223846,
            0.016675207763910294,
            -0.0029985313303768635,
            -0.013612037524580956,
            -0.03780625760555267,
            -0.00645453529432416,
            0.015140414237976074,
            0.05808761343359947,
            -0.01158065628260374,
            -0.050727881491184235,
            -0.021177178248763084,
            -0.01015549711883068,
            -0.013939136639237404,
            0.014350845478475094,
            -0.009196068160235882,
            -0.030245641246438026,
            -0.037296541035175323,
            -0.019819030538201332,
            0.004418736789375544,
            0.021752476692199707,
            0.03173113614320755,
            0.04337093606591225,
            -0.020899195224046707,
            -0.013869167305529118,
            0.009869079105556011,
            0.008183597587049007,
            0.05717356130480766,
            0.02392883412539959,
            -0.016812345013022423,
            0.002597061451524496,
            0.03624642640352249,
            0.0011650746455416083,
            -0.014483652077615261,
            0.07749750465154648,
            -0.0007219398976303637,
            0.04711941257119179,
            -0.0016069160774350166,
            -0.011253860779106617,
            0.04506545141339302,
            0.039484184235334396,
            0.058495521545410156,
            0.0402597114443779,
            0.015823375433683395,
            0.03743604198098183,
            -0.00529690133407712,
            -0.046522997319698334,
            0.04814555123448372,
            -0.004129283595830202,
            0.007174987345933914,
            0.04668109118938446,
            -0.018839433789253235,
            -0.006336284801363945,
            -0.019582422450184822,
            -0.002525379415601492,
            -0.005477604456245899,
            -0.004185967613011599,
            0.020737575367093086,
            -0.021101562306284904,
            0.05977557972073555,
            -0.06509242951869965,
            0.0368451252579689,
            -0.07186117768287659,
            0.025255326181650162,
            -0.06272879987955093,
            0.026281539350748062,
            0.003670759964734316,
            0.0476517453789711,
            -0.0024349270388484,
            0.01813114434480667,
            -0.03025241754949093,
            -0.021253114566206932,
            -0.0036844920832663774,
            -0.010821539908647537,
            -0.009646288119256496,
            0.005983698181807995,
            0.05581173673272133,
            0.0038872191216796637,
            0.02573966234922409,
            -0.00016607571160420775,
            -0.06845784187316895,
            0.017183028161525726,
            -0.036772049963474274,
            -0.0012175224255770445,
            -0.03806813433766365,
            0.033110007643699646,
            0.04592432454228401,
            -0.016870340332388878,
            0.04310774430632591,
            -0.043916475027799606,
            0.01998073235154152,
            0.004362576175481081,
            0.061348266899585724,
            -0.0068273707292973995,
            -0.003881580661982298,
            0.036847539246082306,
            -0.04235908389091492,
            0.03241489827632904,
            0.014462231658399105,
            -0.005513899493962526,
            0.050235286355018616,
            0.029546000063419342,
            0.0387331061065197,
            -0.07736297696828842,
            -0.01755552738904953,
            0.006406036205589771,
            -0.02896043099462986,
            -0.004969432950019836,
            0.02841702476143837,
            0.03816210851073265,
            0.04373827576637268,
            0.05812646821141243,
            0.02879367582499981,
            -0.07132521271705627,
            0.002757288282737136,
            -0.010266833007335663,
            -0.011486397124826908,
            0.005591951310634613,
            -0.016776183620095253,
            -0.02638115920126438,
            -0.021711453795433044,
            -0.03330953046679497,
            0.03579295799136162,
            -0.020404834300279617,
            0.015017685480415821,
            -0.019952749833464622,
            0.028531864285469055,
            0.04734891280531883,
            -0.025751646608114243,
            0.008474770933389664,
            -0.07377270609140396,
            0.029594089835882187,
            0.008993387222290039,
            0.051379311829805374,
            0.044680848717689514,
            0.033825796097517014,
            0.02922438457608223,
            -0.0015875002136453986,
            -0.025312963873147964,
            -0.020062308758497238,
            -0.03906097263097763,
            -0.0035592992790043354,
            -0.014210143126547337,
            -0.009709151461720467,
            0.03184284269809723,
            -0.05291140079498291,
            -0.06685823947191238,
            -0.0373268760740757,
            0.03654438257217407,
            -0.021314920857548714,
            -0.0037871666718274355,
            -0.010825997218489647,
            0.006790516432374716,
            -0.0037417339626699686,
            -0.03282058238983154,
            -0.013347983360290527,
            0.026933319866657257,
            0.014914080500602722,
            0.02792416326701641,
            0.04140911623835564,
            -0.026232123374938965,
            -0.00699632940813899,
            0.02836112678050995,
            0.037559688091278076,
            0.020425328984856606,
            -0.025897204875946045,
            -0.038181327283382416,
            0.0004460987402126193,
            -0.022673970088362694,
            -0.013569628819823265,
            -0.009868260473012924,
            0.002629572292789817,
            -0.011071662418544292,
            -0.016591869294643402,
            0.027456628158688545,
            -0.0034011134412139654,
            -0.029787329956889153,
            0.011258590035140514,
            -0.027099760249257088,
            -0.02272344008088112,
            -0.035167060792446136,
            -0.00272304005920887,
            -0.028142649680376053,
            0.006521680857986212,
            -0.031161393970251083,
            -0.032196447253227234,
            0.050418321043252945,
            -0.00022331673244480044,
            0.004845109768211842,
            -0.005364289507269859,
            0.013768821954727173,
            -0.005380474962294102,
            0.007537337951362133,
            0.0094869714230299,
            0.006034839898347855,
            -0.005279833450913429,
            -0.03237248212099075,
            -0.009473088197410107,
            -0.026264717802405357,
            0.048749834299087524,
            0.005811391863971949,
            0.02021460235118866,
            0.05522359907627106,
            0.06733289361000061,
            0.00260729668661952,
            0.039670445024967194,
            0.03928390145301819,
            -0.05882727727293968,
            0.0035800307523459196,
            -0.024675676599144936,
            -0.00989848468452692,
            0.0042280047200620174,
            0.010074105113744736,
            0.004180463962256908,
            0.04315368831157684,
            0.0030444327276200056,
            -0.014440278522670269,
            0.0357341505587101,
            -0.003887534374371171,
            -0.0003638657508417964,
            0.005724719259887934,
            0.01952458918094635,
            0.001765129854902625,
            -0.012786122038960457,
            -0.01427383441478014,
            -0.021697472780942917,
            0.020477917045354843,
            0.01574811525642872,
            0.02826022356748581,
            0.0065724728628993034,
            0.011906515806913376,
            0.020310157909989357,
            0.029806850478053093,
            -0.029329020529985428,
            -0.0631881058216095,
            -0.08003031462430954,
            -0.060958653688430786,
            0.007879067212343216,
            0.012059816159307957,
            -0.03703635558485985,
            0.046905793249607086,
            -0.00027383543783798814,
            0.027606366202235222,
            -0.01232189405709505,
            -0.021327760070562363,
            -0.008758123964071274,
            0.05705222487449646,
            -0.05152572691440582,
            0.034080080687999725,
            0.018094893544912338,
            -0.07000219821929932,
            -0.035876259207725525,
            -0.015611397102475166,
            0.0318719819188118,
            0.02131984569132328,
            0.007850758731365204,
            0.03690505400300026,
            0.045134492218494415,
            -0.006234400440007448,
            0.011939188465476036,
            0.035164859145879745,
            0.0005853567272424698,
            0.0553339384496212,
            -0.007030446548014879,
            -0.05249970778822899,
            -0.007298759184777737,
            0.0021962840110063553,
            0.016834117472171783,
            0.038969241082668304,
            0.00040840741712599993,
            -0.028240852057933807,
            0.05027209222316742,
            -0.04196872189640999,
            0.012945442460477352,
            0.026524405926465988,
            -0.017735760658979416,
            -0.01606203243136406,
            -0.0012112059630453587,
            -0.011910016648471355,
            0.024436751380562782,
            0.0568961463868618,
            0.009346838109195232,
            -0.016934655606746674,
            0.02053232677280903,
            0.02534974180161953,
            -0.013669873587787151,
            0.029011184349656105,
            0.014465538784861565,
            -0.022679859772324562,
            0.03798223286867142,
            -0.03451705351471901,
            -0.04603073373436928,
            -0.001237479504197836,
            -0.019528815522789955,
            -0.0014731697738170624,
            -0.004941700492054224,
            0.011909853667020798,
            0.042659640312194824,
            0.01126099657267332,
            0.004262944217771292,
            0.03368350490927696,
            0.010827569290995598,
            0.029117198660969734,
            0.05208819359540939,
            0.006987494416534901,
            -0.033741019666194916,
            0.0443115234375,
            -0.0018241523066535592,
            -0.04537922516465187,
            -0.030996637418866158,
            -0.01406914833933115,
            0.03358195722103119,
            -0.03912242874503136,
            0.05335819348692894,
            0.018369873985648155,
            0.016344277188181877,
            -0.02789248526096344,
            0.01834729313850403,
            -0.04617976397275925,
            0.03685944527387619,
            0.005136802792549133,
            -0.029491109773516655,
            -0.028415989130735397,
            -0.011933999136090279,
            0.019413350149989128,
            0.0014996638055890799,
            0.008999654091894627,
            0.03294147551059723,
            -0.0022358756978064775,
            -0.014605344273149967,
            0.02516901306807995,
            -0.015108094550669193,
            0.01293991133570671,
            -0.035219572484493256,
            0.025211842730641365,
            0.028094783425331116,
            0.015392218716442585,
            0.017184043303132057,
            0.0065034786239266396,
            0.027426430955529213,
            -0.013362190686166286,
            0.008655411191284657,
            -0.06565211713314056,
            0.01926209032535553,
            -0.06258141994476318,
            -0.020609838888049126,
            -0.021010197699069977,
            -0.010467181913554668,
            0.02135981246829033,
            -0.028401758521795273,
            0.08431702107191086,
            -0.015964588150382042,
            0.004932940471917391,
            0.030700424686074257,
            -0.026425860822200775,
            0.019608454778790474,
            -0.003544369013980031,
            0.00008017825894057751,
            0.006985792424529791,
            -0.013249634765088558,
            -0.008621353656053543,
            0.001968350261449814,
            -0.041886743158102036,
            -0.01948222704231739,
            0.002705223159864545,
            -0.006927065551280975,
            -0.045195091515779495,
            0.07745286822319031,
            -0.041363079100847244,
            0.07532050460577011,
            0.032347843050956726,
            -0.004439591895788908,
            0.04859426990151405,
            0.02365506812930107,
            0.010199753567576408,
            -0.019528960809111595,
            -0.013194406405091286,
            0.011345678940415382,
            0.01126656774431467,
            0.0029825763776898384,
            -0.02785683609545231,
            0.038460083305835724,
            -0.0352078415453434,
            -0.0037869527004659176,
            0.03250308334827423,
            -0.04573025926947594,
            0.0033691509161144495,
            -0.026219481602311134,
            -0.03618074953556061,
            -0.010012648068368435,
            -0.026874370872974396,
            0.006926747038960457,
            0.007380510680377483,
            0.03234200179576874,
            0.06919417530298233,
            0.03565117344260216,
            0.004553389269858599,
            -0.009126102551817894,
            -0.0726483017206192,
            0.06312277168035507,
            0.0035826838575303555,
            0.020981749519705772,
            0.055863138288259506,
            -0.0023966720327734947,
            -0.02081487514078617,
            0.03403340280056,
            -0.01978735253214836,
            0.005692684557288885,
            0.04540920630097389,
            0.031223507598042488,
            0.004609139636158943,
            -0.04046032577753067,
            -0.010757500305771828,
            -0.05059831589460373,
            -0.016291264444589615,
            -0.02017786353826523,
            0.020463500171899796,
            -0.017823481932282448,
            -0.010179712437093258,
            0.03035629354417324,
            -0.023353539407253265,
            0.008750202134251595,
            -0.05511241778731346,
            -0.02088134177029133,
            -0.03364105895161629,
            0.05224185064435005,
            0.021225757896900177,
            -0.027600223198533058,
            -0.009153283201158047,
            -0.017018280923366547,
            0.039092086255550385,
            -0.00904479343444109,
            0.012617098167538643,
            0.039083439856767654,
            -0.04986721649765968,
            -0.00967467576265335,
            -0.039586517959833145,
            0.02816600538790226,
            0.04502835497260094,
            0.0646541640162468,
            -0.022541580721735954,
            0.002069648588076234,
            0.05169946700334549,
            -0.009947068989276886,
            0.027417201548814774,
            -0.001880348427221179,
            -0.051574304699897766,
            -0.006986258551478386,
            -0.019613739103078842,
            -0.04558134451508522,
            -0.060707855969667435,
            0.01835760660469532,
            0.015498033724725246,
            -0.015274972654879093,
            0.07319467514753342,
            0.005913801025599241,
            0.02475125528872013,
            0.02125382050871849,
            0.0035397917963564396,
            0.010275824926793575,
            0.025532091036438942,
            0.015081796795129776,
            0.0008738969918340445,
            0.028955776244401932,
            -0.015925876796245575,
            0.010645957663655281,
            -0.009858186356723309,
            0.02831451967358589,
            -0.00864169280976057,
            0.04203583672642708,
            -0.0004681939899455756,
            -0.01568404585123062,
            -0.039589330554008484,
            0.01074191089719534,
            -0.054600153118371964,
            -0.04127059131860733,
            -0.04447879642248154,
            0.010894318111240864,
            -0.060483258217573166,
            -0.015090445056557655,
            -0.07968542724847794,
            -0.04445987194776535,
            -0.030708415433764458,
            -0.02272968180477619,
            0.00291151599958539,
            0.018844973295927048,
            -0.024614306166768074,
            -0.02650398574769497,
            0.02067861519753933,
            0.0029990249313414097,
            0.018265580758452415,
            0.0634845420718193,
            0.018314870074391365,
            -0.0001413981372024864,
            -0.03143445402383804,
            -0.01827072538435459,
            -0.0013346212217584252,
            -0.017783494666218758,
            -0.03438954055309296,
            -0.0005956969107501209,
            -0.02126951329410076,
            0.02345050312578678,
            -0.019758040085434914,
            0.019846448674798012,
            0.01703169196844101,
            0.06413421034812927,
            0.0004303845053073019,
            0.008680058643221855,
            0.020176582038402557,
            0.009898113086819649,
            0.044037915766239166,
            -0.01578315906226635,
            0.018839528784155846,
            -0.026777852326631546,
            0.01631615310907364,
            -0.03351986035704613,
            -0.04483649134635925,
            -0.014623302966356277,
            0.02742200717329979,
            -0.023306118324398994,
            -0.02976732887327671,
            -0.00773652596399188,
            -0.026443855836987495,
            -0.023340625688433647,
            -0.018604880198836327,
            -0.04406467080116272,
            0.026296067982912064,
            0.01747472770512104,
            0.056790731847286224,
            0.03936667740345001,
            0.0130765987560153,
            -0.007954727858304977,
            -0.01185567770153284,
            -0.009717665612697601,
            -0.04536188766360283,
            0.008316976018249989,
            0.02548353374004364,
            0.0184940118342638,
            0.003462440799921751,
            -0.038052331656217575,
            0.03585052490234375,
            -0.05685749650001526,
            0.005505872890353203,
            -0.022342750802636147,
            0.012030347250401974,
            0.045314986258745193,
            -0.0035556901711970568,
            -0.009785966947674751,
            -0.002291461918503046,
            -0.036122050136327744,
            -0.03733184561133385,
            0.0018948775250464678,
            -0.024229539558291435,
            0.0024513232056051493,
            -0.017559334635734558,
            0.06209968030452728,
            0.006832167971879244,
            0.0005405957344919443,
            0.026182131841778755,
            -0.002303298795595765,
            0.027133917436003685,
            -0.002456352114677429,
            0.035803329199552536,
            -0.024795301258563995,
            -0.009683137759566307,
            -0.05472823232412338,
            -0.02641746960580349,
            -0.00982159934937954,
            0.02230765111744404,
            0.02090279757976532,
            -0.015491333790123463,
            0.0001543839171063155,
            0.012137278914451599,
            -0.02221831865608692,
            0.034155748784542084,
            -0.05128030478954315,
            -0.06421269476413727,
            -0.005669762846082449,
            -0.03210871294140816,
            -0.01154153048992157,
            0.05074038729071617,
            -0.030304521322250366,
            0.029510507360100746,
            0.008039286360144615,
            -0.010811332613229752,
            0.026409775018692017,
            -0.016649780794978142,
            0.03420131281018257,
            0.014495613053441048,
            0.03407084569334984,
            -0.020022999495267868,
            0.021672330796718597,
            -0.009113247506320477,
            0.014431333169341087,
            0.001218919176608324,
            -0.03958339989185333,
            -0.03270861133933067,
            -0.01953352428972721,
            0.02274680696427822,
            0.014818495139479637,
            -0.0464102178812027,
            0.035424403846263885,
            0.039999037981033325,
            0.04166827350854874,
            0.03060789778828621,
            -0.0044307345524430275,
            0.019694415852427483,
            0.05785850062966347,
            -0.004153033252805471,
            -0.049075834453105927,
            0.03366807475686073,
            -0.020996039733290672,
            0.04295211285352707,
            -0.027984146028757095,
            -0.023799391463398933,
            0.006093265488743782,
            -0.019217051565647125,
            -0.022170454263687134,
            0.02021174319088459,
            -0.015965843573212624,
            0.006925495341420174,
            0.009842951782047749,
            0.00129622220993042,
            -0.039767924696207047,
            0.021534781903028488,
            -0.03852690011262894,
            -0.000030031891583348624,
            0.07081682235002518,
            0.05376603081822395,
            -0.03441529721021652,
            0.014118985272943974,
            0.0011359892087057233,
            -0.011524463072419167,
            -0.015157029964029789,
            0.04333672672510147,
            -0.0002066739834845066,
            -0.013682233169674873,
            -0.025680378079414368,
            0.00009304614650318399,
            0.05485636740922928,
            0.04652567580342293,
            0.016098815947771072,
            -0.02461058460175991,
            0.02477513626217842,
            -0.01868586614727974,
            0.052240289747714996,
            0.012345111928880215,
            0.01976630836725235,
            0.012906450778245926,
            -0.01435026340186596,
            -0.014795142225921154,
            -0.006787148769944906,
            0.0728878602385521,
            -0.02318110503256321,
            -0.02035750448703766,
            0.005055630579590797,
            -0.011543541215360165,
            -0.001994041260331869,
            -0.028470657765865326,
            0.03668176755309105,
            0.009679889306426048,
            -0.001390515943057835,
            0.0046585737727582455,
            0.02028944529592991,
            -0.0004813381819985807,
            -0.013089827261865139,
            -0.023731043562293053,
            -0.030857445672154427,
            0.055327605456113815,
            -0.02573668211698532,
            -0.04323309659957886,
            -0.020654918625950813,
            -0.010228225961327553,
            0.0225937869399786,
            -0.011136072687804699,
            0.039376143366098404,
            0.05793800577521324,
            0.013717190362513065,
            -0.050146572291851044,
            -0.0046950760297477245,
            -0.013307020999491215,
            -0.014614103361964226,
            -0.010249939747154713,
            0.019281776621937752,
            -0.035096410661935806,
            0.04148930683732033,
            0.05417532101273537,
            0.02225220948457718,
            0.029382934793829918,
            0.028356192633509636,
            -0.024215469136834145,
            -0.019085939973592758,
            -0.02693704329431057,
            -0.038791440427303314,
            -0.057574380189180374,
            0.014854014851152897,
            -0.031695656478405,
            0.013847733847796917,
            -0.0029872427694499493,
            0.05789070576429367,
            0.06661735475063324,
            0.0015271076699718833,
            0.0006937370053492486,
            -0.01195269264280796,
            0.0005740319029428065,
            0.04561680927872658,
            -0.0017163873417302966,
            -0.018475651741027832,
            -0.0073736063204705715,
            0.0048711784183979034,
            -0.00664847856387496,
            -0.034588877111673355,
            -0.023481519892811775,
            0.012255103327333927,
            0.011791491881012917,
            0.034374501556158066,
            0.04448239132761955,
            -0.04019356891512871,
            0.052300259470939636,
            0.005128219723701477,
            0.011330120265483856,
            -0.03878295049071312,
            0.09425604343414307,
            -0.013661008328199387,
            0.010919300839304924,
            -0.011309507302939892,
            -0.010774899274110794,
            0.052717000246047974,
            -0.0554579496383667,
            0.009124782867729664,
            -0.0008996040560305119,
            0.010088142938911915,
            0.02155459113419056,
            -0.04035994037985802,
            0.012596161104738712,
            0.027273038402199745,
            -0.03395722806453705,
            -0.033317066729068756,
            -0.005295498762279749,
            -0.012342959642410278,
            -0.09783638268709183,
            0.00485896784812212,
            0.023307502269744873,
            0.011050855740904808,
            0.032566096633672714,
            0.017768820747733116,
            -0.005346872843801975,
            0.0412086620926857,
            -0.007664021570235491,
            0.021272778511047363,
            -0.023624088615179062,
            0.06363194435834885,
            0.039921242743730545,
            -0.00270093628205359,
            -0.010230432264506817,
            -0.024462925270199776,
            -0.016186201944947243,
            0.004110622685402632,
            -0.012416267767548561,
            0.01635795645415783,
            0.01909179426729679,
            0.037502728402614594,
            -0.014867208898067474,
            0.014685828238725662,
            -0.08330681920051575,
            -0.005216531455516815,
            -0.013300629332661629,
            -0.04502848908305168,
            -0.04924961179494858,
            0.03445426747202873,
            -0.02198140323162079,
            0.010483402758836746,
            -0.015476939268410206,
            0.042098067700862885,
            0.00008079754479695112,
            0.02011825516819954,
            -0.0030097379349172115,
            0.02518155798316002,
            0.044855996966362,
            -0.06863050907850266,
            -0.0055152056738734245,
            0.0397619791328907,
            0.001591658336110413,
            0.03149712458252907,
            -0.03033255971968174,
            -0.021375136449933052,
            0.010294546373188496,
            0.004393334034830332,
            0.04855155944824219,
            0.011007950641214848,
            -0.04786423593759537,
            0.09368385374546051,
            -0.036923300474882126,
            0.029134294018149376,
            0.03947389870882034,
            0.03630385175347328,
            0.010327234864234924,
            0.005806865636259317,
            -0.01543221715837717,
            0.007245180197060108,
            -0.020169178023934364,
            0.001286580809392035,
            -0.0090933321043849,
            0.011068770661950111,
            -0.02340427227318287,
            0.044572558254003525,
            0.022698940709233284,
            -0.015802815556526184,
            0.07444695383310318,
            0.09092160314321518,
            -0.04469380900263786,
            -0.03185795247554779,
            -0.026027051731944084,
            -0.014202882535755634,
            0.03852897509932518,
            0.025433331727981567,
            0.02607809193432331,
            0.04402581602334976,
            -0.033092696219682693,
            -0.026748931035399437,
            -0.03747094050049782,
            -0.020080070942640305,
            0.014558612369000912,
            0.0021046639885753393,
            -0.024676017463207245,
            -0.016317090019583702,
            0.016881447285413742,
            -0.05049099028110504,
            -0.01995779015123844,
            0.03320065885782242,
            -0.009816411882638931,
            0.029782520607113838,
            0.00015395272930618376,
            -0.03364503011107445,
            0.07770807296037674,
            0.03301430866122246,
            0.025222405791282654,
            0.06941599398851395,
            -0.0023732795380055904,
            0.04796219617128372,
            -0.06619324535131454,
            0.012011407874524593,
            -0.03961612656712532,
            -0.006606494542211294,
            0.025633757933974266,
            0.032380275428295135,
            0.03878655284643173,
            -0.024384520947933197,
            0.039640530943870544,
            0.015122315846383572,
            -0.0131778409704566,
            -0.029731424525380135,
            0.007861415855586529,
            -0.022008895874023438,
            -0.023148003965616226,
            -0.013378198258578777,
            -0.0029941496904939413,
            -0.0010656400118023157,
            -0.00943844299763441,
            0.02125472016632557,
            -0.004359701182693243,
            0.013418442569673061,
            0.018179718405008316,
            -0.043528828769922256,
            -0.008879713714122772,
            0.059337764978408813,
            -0.02814514748752117,
            -0.0679541826248169,
            0.0005166465416550636,
            -0.0006998691242188215,
            0.05901530757546425,
            -0.016155119985342026,
            -0.0123760886490345,
            -0.01841278001666069,
            0.028017016127705574,
            0.05507887154817581,
            0.013152251951396465,
            -0.060713622719049454,
            -0.02863653004169464,
            -0.014563258737325668,
            -0.029293961822986603,
            0.02294907718896866,
            -0.03336506336927414,
            0.031798526644706726,
            0.00579344667494297,
            0.0076512726955115795,
            -0.016523439437150955,
            -0.01224720012396574,
            0.008529947139322758,
            -0.03684084117412567,
            -0.03819189593195915,
            0.05251205712556839,
            -0.02246219664812088,
            -0.02809792384505272,
            -0.03583883121609688,
            -0.03909865766763687,
            -0.010964044369757175,
            0.0030212809797376394,
            -0.03283819183707237,
            -0.05652885138988495,
            -0.010628745891153812,
            -0.002991705434396863,
            0.02283613570034504,
            0.06193573772907257,
            0.01885121315717697,
            -0.02978639490902424,
            -0.04486739635467529,
            0.05725904554128647,
            -0.032276663929224014,
            -0.01759260892868042,
            -0.04337267205119133,
            -0.007297576405107975,
            -0.02896256372332573,
            -0.038389790803194046,
            0.027767259627580643,
            0.09512488543987274,
            -0.016746193170547485,
            -0.045723117887973785,
            0.01653941161930561,
        ]
    }
    from numpy import dot
    from numpy.linalg import norm

    cos_sim = dot(v_emb_test["embedding"], a_emb_test["embedding"]) / (
        norm(v_emb_test["embedding"]) * norm(a_emb_test["embedding"])
    )
    print(cos_sim)

    return sim


def embed_text_itm(model, prompt, video_emb, query_tokens=None, video_atts=None):
    inputs = model.tokenizer(prompt, padding="max_length", truncation=True, max_length=320, return_tensors="pt").to("cuda")

    if query_tokens is None:
        query_tokens = model.video_query_tokens.expand(video_emb.shape[0], -1, -1)
    query_atts = torch.ones(query_tokens.size()[:-1], dtype=torch.long).to(video_emb.device)

    attention_mask = torch.cat([query_atts, inputs.attention_mask], dim=1)
    if video_atts is None:
        video_atts = torch.ones(video_emb.size()[:-1], dtype=torch.long).to(video_emb.device)

    output_itm = model.video_Qformer.bert(
        inputs.input_ids,
        query_embeds=query_tokens,
        attention_mask=attention_mask,
        encoder_hidden_states=video_emb,
        encoder_attention_mask=video_atts,
        return_dict=True,
    )
    itm_embeddings = output_itm.last_hidden_state[:, : query_tokens.size(1), :]
    # itm_logit = itm_embeddings.mean(dim=1)
    itm_logit = itm_embeddings[:, -1, :]

    return itm_logit


def compute_itm(model, prompts, video_emb):
    text_embs = []
    for prompt in prompts:
        text_embs.append(embed_text_itm(model, prompt, video_emb))
    text_embs = torch.cat(text_embs)

    sim_q2t = torch.einsum("iqf,tf->itq", video_emb, text_embs)
    sim, _ = sim_q2t.max(-1)
    return sim


def compute_sim(model, prompts, video_embs, mode="itc"):
    sims = []
    for video_emb in video_embs:
        if mode == "itc":
            sim = compute_itc(model, prompts, video_emb)
        if mode == "itm":
            sim = compute_itm(model, prompts, video_emb)
        sims.append(sim)
    return sims


def rank_matches(prompts, video_paths, model, vis_processor):
    video_embs = get_all_video_embeddings(video_paths, model, vis_processor)
    sims = compute_sim(model, prompts, video_embs)

    sorted_sims = sorted(zip(video_paths, sims, strict=False), key=lambda x: x[1])
    for video_path, sims in sorted_sims:
        print(video_path, sims.cpu().detach().numpy().item())


if __name__ == "__main__":
    eval_config = "eval_configs/video_clip_v0.2.yaml"

    gpu_id = 0
    args = {"cfg_path": eval_config, "gpu_id": gpu_id, "options": None}
    args = Namespace(**args)
    model, vis_processor, img_processor = init(args)

    video_paths = glob.glob("data/*.mp4")

    prompt = "zebra"
    yappi.set_clock_type("cpu")
    yappi.start()
    start_time = datetime.datetime.now()
    # rank_matches_videoq(video_paths[1], video_paths, model, vis_processor)
    rank_matches([prompt], video_paths, model, vis_processor)
    # embs=get_all_video_embeddings(video_paths, model, vis_processor)
    # sim = compute_sim(model,prompts=["kak on tam"],video_embs=embs)

    # get_all_video_embeddings(video_paths, model, vis_processor)
    yappi.stop()

    # print(sim)
    # print(embs)

    end_time = datetime.datetime.now()
    print("Waste time %s" % (end_time - start_time))
    # yappi.get_func_stats().print_all()
    curr_date = str(datetime.datetime.now().date()).replace("-", ".")
    filename = "yappi_profile." + curr_date + ".pstat"
    filepath = os.path.join(os.getcwd(), filename)
    stats = yappi.get_func_stats()
    stats.save(filepath, type="PSTAT")

    subprocess.run(["gprof2dot", "-f", "pstats", filename, "-o", "yappi_graph.dot"], check=False)
    subprocess.run(["dot", "-Tsvg", "yappi_graph.dot", "-o", "tmp/yappi_graph.html"], check=False)
    os.unlink(filepath)
    os.unlink(os.path.join(os.getcwd(), "yappi_graph.dot"))
    print("File yappi_graph.html is Done !!!!")


# def main():
#     eval_config = "eval_configs/video_clip_v0.2.yaml"
#     gpu_id = 0
#     args = {"cfg_path": eval_config, "gpu_id": gpu_id, "options": None}
#     args = Namespace(**args)
#     model, vis_processor, img_processor = init(args)

#     video_paths = glob.glob("data/*.mp4")
#     prompt = "zebra"
#     start = time.time()
#     rank_matches([prompt], video_paths, model, vis_processor)
#     print(time.time() - start)


# def save_trace_to_file(prof, output_dir="./log", file_name="trace.json"):
#     if not os.path.exists(output_dir):
#         os.makedirs(output_dir)
#     trace_path = os.path.join(output_dir, file_name)
#     prof.export_chrome_trace(trace_path)
#     print(f"Trace saved to {trace_path}")

# if __name__ == "__main__":
#     with torch.profiler.profile(
#         activities=[
#             torch.profiler.ProfilerActivity.CPU,
#             torch.profiler.ProfilerActivity.CUDA,
#         ],
#         schedule=torch.profiler.schedule(wait=1, warmup=1, active=3, repeat=2),
#         on_trace_ready=save_trace_to_file,
#         record_shapes=True,
#         profile_memory=True,
#         with_stack=True,

#     ) as prof:
#         main()
#         prof.step()
#     prof.export_stacks("./log/results_cpu.txt","self_cpu_time_total")
#     prof.export_stacks("./log/results_gpu.txt","self_cuda_time_total")
#     # prof.export_memory_timeline("./log/mem.html")
#     prof.export_chrome_trace("./log/chrome_trace.json")
